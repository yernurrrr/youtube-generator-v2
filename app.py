import streamlit as st
import os
from google import genai
from google.genai.errors import APIError

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø API –ò –ú–û–î–ï–õ–ò ---
# –ö–ª—é—á GEMINI_API_KEY –±—É–¥–µ—Ç –ø–æ–ª—É—á–µ–Ω –∏–∑ Streamlit Secrets (–∏–ª–∏ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
MODEL_NAME = "gemini-2.5-flash"
FREE_LIMIT = 5 # –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è –ª–∏–º–∏—Ç–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

def generate_titles(prompt_text, style):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –º–æ–¥–µ–ª–∏ Gemini, –≤–∫–ª—é—á–∞—è –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å."""
    if not GEMINI_API_KEY:
        return "–û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω GEMINI_API_KEY. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–∞ Streamlit Cloud)."

    client = genai.Client(api_key=GEMINI_API_KEY)

    # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (—Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç), –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –º–æ–¥–µ–ª—å "—ç–∫—Å–ø–µ—Ä—Ç–æ–º"
    system_instruction = (
        f"–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã—Ö –∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è YouTube-–≤–∏–¥–µ–æ. –¢–≤–æ–π —Å—Ç–∏–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: '{style}'. "
        "–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–∫–æ–º –∏–∑ 5 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –Ω–µ –¥–æ–±–∞–≤–ª—è—è –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤."
    )

    full_prompt = (
        f"–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è YouTube-–≤–∏–¥–µ–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–π —Ç–µ–º—ã: '{prompt_text}'"
    )

    try:
        response = client.models.generate_content(
            model=MODEL_NAME,
            contents=full_prompt,
            config={"system_instruction": system_instruction}
        )
        return response.text
    except APIError as e:
        return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ API: {e}"
    except Exception as e:
        return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}"

# --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê STREAMLIT ---

st.set_page_config(page_title="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ó–∞–≥–æ–ª–æ–≤–∫–æ–≤", layout="centered")
st.title("üî• –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è YouTube (MVP)")

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ß–ï–¢–ß–ò–ö–ê –í –°–ï–°–°–ò–ò ---
if 'count' not in st.session_state:
    st.session_state.count = 0

# –í—ã–≤–æ–¥ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—é (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ)
st.markdown(f"**–í–∞—à —Å—Ç–∞—Ç—É—Å:** –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π. üîë **–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤:** {FREE_LIMIT - st.session_state.count}")
st.markdown("---")
st.markdown(
    "**‚ö°Ô∏è –ù—É–∂–Ω—ã –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã?** [–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –∑–¥–µ—Å—å! (–í–∞—à–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ Boosty/Patreon)](–í–ê–®–ê_–°–°–´–õ–ö–ê_–î–õ–Ø_–û–ü–õ–ê–¢–´)"
)
st.markdown("---")

# 1. –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–º—ã
text_input = st.text_input("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –≤–∞—à–µ–≥–æ –≤–∏–¥–µ–æ:", placeholder="–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –≤—ã—É—á–∏—Ç—å Python", key="topic")

# 2. –ü–æ–ª–µ –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è
style_selection = st.selectbox(
    "–í—ã–±–µ—Ä–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π —Å—Ç–∏–ª—å –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:",
    options=["–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π", "–ö–ª–∏–∫–±–µ–π—Ç–Ω—ã–π (–∏–Ω—Ç—Ä–∏–≥—É—é—â–∏–π)", "–Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π", "–°–µ—Ä—å–µ–∑–Ω—ã–π"],
    key="style"
)

# 3. –ü—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
results_placeholder = st.empty()

if st.button("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å üöÄ"):

    # --- –õ–û–ì–ò–ö–ê –ü–†–û–í–ï–†–ö–ò –õ–ò–ú–ò–¢–ê ---
    if st.session_state.count >= FREE_LIMIT:
        results_placeholder.error(
            "üõë **–õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω.** –í—ã –∏–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–ª–∏ 5 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π. "
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã."
        )
    elif not text_input:
        results_placeholder.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞")
    else:
        # –ï—Å–ª–∏ –ª–∏–º–∏—Ç –Ω–µ –∏—Å—á–µ—Ä–ø–∞–Ω, –≤—ã–ø–æ–ª–Ω—è–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
        with st.spinner("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥."):

            # –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            result_text = generate_titles(text_input, style_selection)

            # *** –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–ê –í –ö–û–ù–¢–ï–ô–ù–ï–†–ï ***
            with results_placeholder.container():
                st.success("‚úÖ –ì–æ—Ç–æ–≤–æ! –í–∞—à–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏:")
                st.markdown(result_text)

            # *** –£–í–ï–õ–ò–ß–ï–ù–ò–ï –°–ß–ï–¢–ß–ò–ö–ê –ü–û–°–õ–ï –£–°–ü–ï–®–ù–û–ô –ì–ï–ù–ï–†–ê–¶–ò–ò ***
            st.session_state.count += 1
            # –ó–¥–µ—Å—å –ù–ï–¢ st.rerun(), —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ.
            # –°—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
